from shap2llm.explainer import Explainer
import pandas as pd

bike_df = pd.read_csv('../data/bike_sharing_dataset/day.csv', index_col ='dteday')
bike_df.drop('instant', axis=1, inplace=True)
bike_df['temp'] = bike_df['temp']*41
bike_df['atemp'] = bike_df['atemp']*50
bike_df['hum'] = bike_df['hum']*100
bike_df['windspeed'] = bike_df['windspeed']*67


# separate input and output in each dataset
input_columns = ['season', "holiday", 'yr', 'mnth', 'weekday', 'workingday','temp', 'hum', 'windspeed']
output_column =  'registered'


from sklearn.ensemble import RandomForestRegressor

rforest = RandomForestRegressor(n_estimators=1000, max_depth=None, min_samples_split=2, random_state=0)
rforest.fit(bike_df[input_columns], bike_df[output_column])

explainer = Explainer(dataset_context="Bike-sharing rental process is highly correlated to the environmental and seasonal settings. For instance, weather conditions, precipitation, day of week, season, hour of the day, etc. can affect the rental behaviors. The core data set is related to the two-year historical log corresponding to years 2011 and 2012 from Capital Bikeshare system, Washington D.C., USA which is publicly available in http://capitalbikeshare.com/system-data. We aggregated the data on two hourly and daily basis and then extracted and added the corresponding weather and seasonal information. Weather information are extracted from http://www.freemeteo.com.",
        model_task_context="the model predicts total daily count of registered rental bikes",
        model=rforest,
        X_dataset=bike_df[input_columns],
        features_descriptions={"season" : "season (1:springer, 2:summer, 3:fall, 4:winter)",
                                "yr" : "year (0: 2011, 1:2012)",
                                "mnth" : "month (1 to 12)",
"holiday" : "weather day is holiday or not (extracted from http://dchr.dc.gov/page/holiday-schedule)",
"weekday" : "day of the week",
"workingday" : "if day is neither weekend nor holiday is 1, otherwise is 0.",
"weathersit" :"""
    1: Clear, Few clouds, Partly cloudy, Partly cloudy
    2: Mist + Cloudy, Mist + Broken clouds, Mist + Few clouds, Mist
    3: Light Snow, Light Rain + Thunderstorm + Scattered clouds, Light Rain + Scattered clouds
    4: Heavy Rain + Ice Pallets + Thunderstorm + Mist, Snow + Fog""",
"temp" : "temperature in Celsius",
"atemp": "feeling temperature in Celsius",
"hum": "humidity",
"windspeed": "wind speed"},
        shap_algorithm="tree")

print(explainer.describe_graph(feature_name="mnth"))
#tasks=[Task(explanation="The graph displays a clear ascending trend in SHAP values for the feature 'mnth', which represents months from January (1) to December (12). As the month progresses, starting from February to December, the SHAP values consistently increase, indicating a positive relationship between the month of the year and the predicted total daily count of registered rental bikes. The distribution of data values is presented in the light grey area at the bottom, showing that most data points are clustered near the lower months (January through March), with fewer observations for the latter months post-April.", output="The graph shows an increasing trend in SHAP values for the feature 'mnth'."), Task(explanation='One surprising aspect of the graph is the relatively low SHAP values for the initial months (January to March), which suggest a lower impact of these months on bike rentals compared to later months. This is counterintuitive because one might expect rental behavior to be more stable throughout the year, but it indicates that environmental conditions during winter months (e.g., cold weather) likely deter rentals. As the year progresses into warmer months (April to September), the rental counts rise significantly, which is reflected in the increased SHAP values for those months. This behavior could be explained by seasonal preferences for bike rentals, with users being more inclined to rent bikes during warmer seasons.', output='The SHAP values for initial months are notably low, indicating a surprising minimal impact on bike rentals compared to warmer months.'), Task(explanation="The dependence scatter plot illustrates the effect of the 'mnth' feature on the modelâ€™s predictions for daily bike rentals. As the month increases from 1 (January) to 12 (December), the SHAP values demonstrate a clear upward trend, reflecting a positive contribution of the month to the predicted counts, particularly peaking in the later months. The histogram at the bottom indicates a higher density of months early in the year, but as we move to the middle and end of the year, both the SHAP values and the number of predictions increase notably. This suggests that bike-sharing rentals are significantly influenced by seasonal trends, with higher rentals in warmer months and thus a substantial positive impact on predictions. The low SHAP values for winter months highlight the challenges in rental behavior during that period. Overall, month serves as a crucial factor in understanding bike-sharing patterns, heavily influenced by seasonal weather conditions and user preferences.", output='The plot indicates a positive correlation between the month and bike-sharing rentals, with SHAP values increasing significantly through warmer months.')] final_answer="The dependence scatter plot clearly illustrates a significant positive relationship between the month of the year and the total daily count of registered rental bikes. The SHAP values increase as the months progress from January to December, indicating that later months have a more substantial positive effect on predictions. An intriguing aspect is the low SHAP values for early months (January to March), which seems counterintuitive since one might expect a consistent rental rate. This suggests that environmental factors, like winter weather, have a notable impact on bike rentals. The density of data points shows a clustering in the early months, while the upward trend in SHAP values highlights the seasonal variations in bike-sharing behavior. Overall, month plays a vital role in the model's prediction, reflecting the influence of weather and user behavior throughout the year."
print(explainer.describe_graph(feature_name="season"))
#tasks=[Task(explanation="The general pattern of the graph indicates a clear relationship between the 'season' feature and the SHAP values for bike rentals. As the season progresses from spring to summer, and then to fall and winter, the SHAP values show distinct clusters. Each season corresponds to a level of influence on the bike rental predictions, with spring and winter displaying notably lower SHAP values compared to summer and fall, which exhibit higher SHAP values.", output="The graph illustrates a significant influence of the season on the model's predictions concerning bike rentals."), Task(explanation='One surprising aspect is the substantial drop in SHAP values during the spring (season 1) and winter (season 4), where fewer bike rentals are predicted. This might seem counterintuitive as one might expect spring to have a higher rental count due to better weather. Additionally, the effect of summer (season 2) appears to dramatically increase the SHAP values, suggesting a significantly higher model prediction for bike rentals. Such behavior may be influenced by factors such as summer vacations or increased outdoor activities leading to higher bike usage, while winter, on the contrary, could be affected by weather conditions leading to lower usage.', output='The unexpected lower predictions in spring and winter might indicate external factors affecting bike rentals.'), Task(explanation="The dependence scatter plot reveals the impact of the 'season' feature on bike rental predictions, showcasing that spring (1) and winter (4) are associated with lower SHAP values, indicating fewer predicted rentals, while summer (2) and fall (3) correlate with higher SHAP values, implying increased predicted rentals. Spring's low values might seem surprising as it generally heralds warmer weather, suggesting a need to investigate influencing factors like specific weather conditions. Winter's lower SHAP values could be attributed to cold weather deterring bike usage. Overall, the plot effectively highlights the seasonal variations in bike rental behavior, affirming how significant seasonal influences guide rental volumes.", output='The key findings from the plot indicate that the season has a pronounced effect on bike rental predictions, particularly highlighting a low prediction for spring and winter and a high prediction for summer and fall.')] final_answer="The dependence scatter plot illustrates a strong correlation between the 'season' feature and SHAP values affecting bike rental predictions. Notably, summer and fall show higher SHAP values, implying increased bike rentals, while spring and winter are associated with lower predictions. This finding is intriguing, especially since spring is generally expected to encourage outdoor activities, yet it shows reduced rental predictions. Such patterns suggest that other external factors may be influencing the bike rental behavior during these seasons. The overall narrative emphasizes the importance of considering seasonal variations in predicting bike rentals."
print(explainer.describe_graph(feature_name="holiday"))
#tasks=[Task(explanation="The graph shows a clear dependence between the 'holiday' feature and its corresponding SHAP values. The x-axis represents whether a day is a holiday (binary, where 0 indicates it is not a holiday and 1 indicates it is a holiday). The y-axis represents the SHAP values for this feature, which indicate how much knowing the 'holiday' feature changes the model's prediction. Most of the data points cluster at the 'holiday' value of 0, suggesting that on non-holiday days, the SHAP values are predominantly negative, which implies that rentals decrease when it is not a holiday. A smaller cluster at the 'holiday' value of 1 shows a significant increase in SHAP values, indicating a noteworthy positive impact on bike rentals during holidays.", output="The graph illustrates the relationship between the 'holiday' feature and the SHAP values, indicating a strong positive impact during holidays."), Task(explanation='A surprising aspect of the graph is the stark contrast between the SHAP values for holidays and non-holidays. The data points show that during holidays (value 1 on the x-axis), the SHAP values are significantly higher (positive), indicating an increase in the predicted bike rentals. Conversely, the vast majority of predictions for non-holiday days (value 0) show negative SHAP values. This observation could be counterintuitive because one might expect bike rentals to remain relatively stable or not decrease significantly on non-holidays. However, since holidays may attract more recreational use of bikes, this behavior emphasizes the stark differences in rental patterns based on holiday status.', output='The notable contrast in SHAP values for holidays versus non-holidays reveals a significant pattern in bike rental behavior.'), Task(explanation="The dependence scatter plot reveals the impact of the 'holiday' feature on daily bike rentals. The graph illustrates that on non-holiday days (x=0), the SHAP values show predominantly negative values, indicating a decrease in bike rentals, while on holidays (x=1), SHAP values are overwhelmingly positive, showcasing increased rentals. This indicates that bike-sharing usage is significantly higher on holidays compared to regular days. The histogram at the bottom suggests that most data points correspond to non-holiday days, reinforcing the idea that holidays spur a notable increase in rentals. This contrast highlights the importance of holiday status in predicting bike rental behavior.", output='The analysis of the plot indicates a significant relationship between holidays and bike rentals, with marked increases in usage on holiday days.')] final_answer="The dependence scatter plot shows a marked relationship between the 'holiday' feature and SHAP values, where non-holiday days correlate with negative SHAP values (indicating fewer rentals), and holiday days exhibit significantly higher positive SHAP values, indicating increased bike rentals. Most data points are centered around non-holidays, revealing that rentals are considerably lower when it is not a holiday, suggesting a strong effect of holidays on bike rental behavior. This distinctive pattern emphasizes holidays as critical days for bike-sharing usage, highlighting the differing rental patterns likely driven by recreational activities during holidays."
print(explainer.get_improved_metadata())
#ParsedChatCompletionMessage[Explainer.get_improved_metadata.<locals>.ColumnsDescriptions](content='{"descriptions":[{"name":"season","new_name":"Season of the Year","new_description":"Indicates the current season when the bike rentals are happening. It can be one of four options: spring, summer, fall, or winter."},{"name":"yr","new_name":"Year","new_description":"Denotes the year during which the rental took place. It can either be 2011 or 2012."},{"name":"mnth","new_name":"Month","new_description":"Represents the month of the rental, ranging from January (1) to December (12)."},{"name":"holiday","new_name":"Holiday Indicator","new_description":"This feature shows whether the rental day falls on a recognized public holiday."},{"name":"weekday","new_name":"Day of the Week","new_description":"Specifies which day of the week the rental occurred, ranging from Monday (0) to Sunday (6)."},{"name":"workingday","new_name":"Working Day Status","new_description":"Indicates if the rental day is a working day or not. A day is considered a working day if it is neither a weekend nor a holiday."},{"name":"weathersit","new_name":"Weather Situation","new_description":"Describes the weather conditions during the rentals. It includes categories such as clear skies, misty, light snow, and heavy rain."},{"name":"temp","new_name":"Temperature (Celsius)","new_description":"Shows the actual temperature in degrees Celsius at the time of the rental."},{"name":"atemp","new_name":"Feels Like Temperature (Celsius)","new_description":"Represents the \'feels like\' temperature in degrees Celsius, which indicates how the temperature feels to a person due to factors like humidity and wind."},{"name":"hum","new_name":"Humidity Level","new_description":"Indicates the percentage of humidity in the air during the rental."},{"name":"windspeed","new_name":"Wind Speed","new_description":"Shows the speed of the wind in meters per second during the time of rental."}]}', refusal=None, role='assistant', audio=None, function_call=None, tool_calls=[], parsed=ColumnsDescriptions(descriptions=[ColumnsDescription(name='season', new_name='Season of the Year', new_description='Indicates the current season when the bike rentals are happening. It can be one of four options: spring, summer, fall, or winter.'), ColumnsDescription(name='yr', new_name='Year', new_description='Denotes the year during which the rental took place. It can either be 2011 or 2012.'), ColumnsDescription(name='mnth', new_name='Month', new_description='Represents the month of the rental, ranging from January (1) to December (12).'), ColumnsDescription(name='holiday', new_name='Holiday Indicator', new_description='This feature shows whether the rental day falls on a recognized public holiday.'), ColumnsDescription(name='weekday', new_name='Day of the Week', new_description='Specifies which day of the week the rental occurred, ranging from Monday (0) to Sunday (6).'), ColumnsDescription(name='workingday', new_name='Working Day Status', new_description='Indicates if the rental day is a working day or not. A day is considered a working day if it is neither a weekend nor a holiday.'), ColumnsDescription(name='weathersit', new_name='Weather Situation', new_description='Describes the weather conditions during the rentals. It includes categories such as clear skies, misty, light snow, and heavy rain.'), ColumnsDescription(name='temp', new_name='Temperature (Celsius)', new_description='Shows the actual temperature in degrees Celsius at the time of the rental.'), ColumnsDescription(name='atemp', new_name='Feels Like Temperature (Celsius)', new_description="Represents the 'feels like' temperature in degrees Celsius, which indicates how the temperature feels to a person due to factors like humidity and wind."), ColumnsDescription(name='hum', new_name='Humidity Level', new_description='Indicates the percentage of humidity in the air during the rental.'), ColumnsDescription(name='windspeed', new_name='Wind Speed', new_description='Shows the speed of the wind in meters per second during the time of rental.')]))
